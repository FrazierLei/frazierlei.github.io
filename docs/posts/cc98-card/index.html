<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Feifei">
    <meta name="description" content="https://feifeizaici.fun">
    <meta name="keywords" content="blog, murmur">

    <meta property="og:site_name" content="霏霏">
    <meta property="og:title" content="
  CC98抽卡机 - 霏霏
">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://feifeizaici.fun/posts/cc98-card/">
    <meta property="og:image" content="https://feifeizaici.funimages/tn.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="https://feifeizaici.fun/posts/cc98-card/">
    <meta name="twitter:image" content="https://feifeizaici.funimages/tn.png">

    <base href="https://feifeizaici.fun/posts/cc98-card/">
    <title>
  CC98抽卡机 - 霏霏
</title>

    <link rel="canonical" href="https://feifeizaici.fun/posts/cc98-card/">
    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    
    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="../../css/normalize.min.css">
    <link rel="stylesheet" href="../../css/style.min.css">

    

    

    <link rel="icon" type="image/png" href="../../images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="../../images/favicon-16x16.png" sizes="16x16">

    
      <link rel="alternate" href="https://feifeizaici.fun/index.xml" type="application/rss+xml" title="霏霏">
      <link href="https://feifeizaici.fun/index.xml" rel="feed" type="application/rss+xml" title="霏霏" />
    

    <meta name="generator" content="Hugo 0.86.0" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="../../">霏霏</a>
    <input type="checkbox" id="menu-control"/>
    <label class="menu-mobile  float-right " for="menu-control">
      <span class="btn-mobile  float-right ">&#9776;</span>
      <ul class="navigation-list">
        
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://feifeizaici.fun/posts">Blog</a>
            </li>
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://feifeizaici.fun/about">About</a>
            </li>
          
        
        
      </ul>
    </label>
  </section>
</nav>






      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">CC98抽卡机</h1>
      <h2 class="date">November 27, 2020</h2>
    </header>

    <p>抽卡机是我第一个独立完成的小项目，它对我意义非凡。</p>
<h2 id="抽卡什么是抽卡">抽卡？什么是抽卡？</h2>
<p><code>CC98 抽卡</code>是由<code>CC98</code>和 <code>NexusHD </code>共同推出的一款抽卡小游戏。卡牌内容包括 <code>CC98</code>、<code>NexusHD</code>，以及浙江大学相关的各种人事物，不同的卡片具有不同的等级，同时也具有不同的价值和抽取几率。</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/image-20201127181154058.png" alt="个人收藏页面"></p>
<h3 id="等级介绍"><strong>等级介绍</strong></h3>
<ul>
<li><code>Mystery</code>是对98、NHD有杰出贡献的四位用户</li>
<li><code>SSR</code>是98站务组和技术组正式成员、荣誉站长、创始人逗逼形象和NHD维护开发员、管理员</li>
<li><code>SR</code>是98正式版主和全站贵宾、拥有大于等于3个VIP（包括协会退休成员）或威望超过98或帖数超过10w的98用户，NHD总版主和发布员</li>
<li><code>R</code>是98实习版主、认证用户、版面贵宾、98运营管理团队成员和帖数大于等于10000或威望大于等于15的用户</li>
<li><code>N</code>是其他普通用户。</li>
</ul>
<h3 id="等级分布">等级分布</h3>
<table>
<thead>
<tr>
<th>等级</th>
<th>N</th>
<th>R</th>
<th>SR</th>
<th>SSR</th>
<th>Mystery</th>
</tr>
</thead>
<tbody>
<tr>
<td>比例</td>
<td>53.49%</td>
<td>30.00%</td>
<td>15.00%</td>
<td>1.50%</td>
<td>0.01%</td>
</tr>
<tr>
<td>最低数量</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<h2 id="为什么需要抽卡机手动抽不好吗">为什么需要抽卡机，手动抽不好吗</h2>
<p>原因也简单，懒呗。如果要手动抽完每个月从N站兑换来的100万财富值（现在缩水到80万了），就算不每次都全部点开，也得十几二十分钟，费时费力费鼠标。之前有人用按键精灵来抽卡，也算是一种解放劳动力的方案。今年十月份的时候我自学了一些爬虫的基础知识，就想着能不能学以致用，写一个能够完成自动抽卡的Python程序。</p>
<h2 id="第一版抽卡机用cookie绕过登录">第一版抽卡机——用Cookie绕过登录</h2>
<p>起初，我以为所有网站的登录都差不多，无非就是用POST方法提交一个包含用户名和密码的表单，但是显然事情没有我想象得那么简单。</p>
<p>登录CC98抽卡中心需要先登录CC98登录中心</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/image-20201127182903911.png" alt="CC98登录中心登录页面"></p>
<p>登录后，还需要通过抽卡中心发起的许可，方可进入CC98抽卡中心。</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/image-20201127182540195.png" alt="授权许可页面"></p>
<p>在Chrome的开发者工具中看了一下登录CC98登录中心需要提交的信息：</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/image-20201127183141189.png" alt="image-20201127183141189"></p>
<p>完全不知道这个<code>__RequestVerificationToken是</code>从哪来的，复制下来尝试用<code>Requests</code>来模拟登录，得到了状态码为400的响应——登录失败了。</p>
<p>在网上查了很多资料以后发现一种可以绕过登录的方法——保存<code>cookie</code>。</p>
<p>于是我去开发者工具里把抽卡页面的<code>cooki</code>e保存了下来，然后对抽卡的API：<code>https://card.cc98.org/Draw/Run/</code>发送一个POST请求，终于，我第一次成功用Python完成了抽卡。</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/image-20201127183641212.png" alt="在Chrome中查看当前页面cookie"></p>
<h3 id="csrf验证">CSRF验证</h3>
<p>虽然能够抽卡了，我还是十分好奇Form-data里的那个<code>__RequestVerificationToken</code>是怎么来的，通过谷歌，我找到了这样一篇博客：</p>
<p><a href="https://www.jianshu.com/p/e0844a0a5e61">当爬虫遇到CSRF 验证（__RequestVerificationToken）</a></p>
<p>原来这个<code>__RequestVerificationToken</code>是可以从页面的html中找到的，也就是说也可以用程序来获得：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="c1"># 获取CSRF验证</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://card.cc98.org/Draw&#39;</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;__RequestVerificationToken&#39;</span><span class="p">})[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
</code></pre></div><p>于是第一版的抽卡机就完成了我还加了一个小功能，就是把抽到的<code>SSR</code>和<code>M</code>卡显示出来，代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span>

<span class="c1"># 开抽！</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://card.cc98.org/Draw/Run/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">),</span> 
           <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
           <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;content-type&#34;</span><span class="p">:</span><span class="s2">&#34;application/x-www-form-urlencoded; charset=UTF-8&#34;</span><span class="p">},</span>
           <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>

<span class="n">N_cards</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data-level&#39;</span><span class="p">:</span><span class="s1">&#39;0&#39;</span><span class="p">})</span>
<span class="n">R_cards</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data-level&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">})</span>
<span class="n">SR_cards</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data-level&#39;</span><span class="p">:</span><span class="s1">&#39;2&#39;</span><span class="p">})</span>
<span class="n">SSR_cards</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data-level&#39;</span><span class="p">:</span><span class="s1">&#39;3&#39;</span><span class="p">})</span>
<span class="n">M_cards</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data-level&#39;</span><span class="p">:</span><span class="s1">&#39;4&#39;</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;抽到</span><span class="si">{}</span><span class="s1">张N卡，</span><span class="si">{}</span><span class="s1">张R卡，</span><span class="si">{}</span><span class="s1">张SR卡，</span><span class="si">{}</span><span class="s1">张SSR卡，</span><span class="si">{}</span><span class="s1">张M卡！&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">N_cards</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">R_cards</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">SR_cards</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">SSR_cards</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">M_cards</span><span class="p">)))</span>

<span class="n">SSR_M</span> <span class="o">=</span> <span class="n">SSR_cards</span> <span class="o">+</span> <span class="n">M_cards</span>

<span class="c1"># 显示抽到的SSR卡和M卡</span>
<span class="k">if</span> <span class="n">SSR_M</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">SSR_M</span><span class="p">:</span>
        <span class="n">img_src</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;https://card.cc98.org&#39;</span><span class="o">+</span><span class="n">img_src</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div><p>还发现了一个好用的chrome插件：<a href="http://www.editthiscookie.com/start/">EditThisCookie</a>，可以方便的把cookie存下来</p>
<p><img src="http://qiniusave.feifeizaici.xyz/uPic/xf4wgq5s.png" alt="EditThisCookie插件"></p>
<h2 id="第二版抽卡机用selenium获取cookie">第二版抽卡机——用Selenium获取Cookie</h2>
<p>第一版的抽卡机虽然可以将大部分工作自动完成，但是还是有一个手动操作的环节——复制一下<code>cookie</code>。</p>
<p>实验室旁边工位的师兄是一个<code>Selenium</code>大师，他建议用它试试，试试就试试。其实并没有什么难度，就是学习<code>xpath</code>表达式的时候略微花了一些功夫。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.chrome.options</span> <span class="kn">import</span> <span class="n">Options</span>

<span class="n">chrome_options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">()</span>
<span class="c1"># chrome_options.add_argument(&#34;--headless&#34;)</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">chrome_options</span><span class="p">)</span>

<span class="c1"># 登录CC98登录中心</span>
<span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://openid.cc98.org/Account/LogOn&#39;</span><span class="p">)</span>
<span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;UserName&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;用户名&#39;</span><span class="p">)</span>
<span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;Password&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;密码&#39;</span><span class="p">)</span>
<span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s1">&#39;//button[text()=&#34;立即登录&#34;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>

<span class="c1"># # 授权给CC98抽卡中心</span>
<span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://card.cc98.org/&#39;</span><span class="p">)</span>
<span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s1">&#39;//*[text()=&#34;登录&#34;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
<span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s2">&#34;//button[@class=&#39;btn btn-success&#39;]&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>

<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">driver</span><span class="o">.</span><span class="n">get_cookies</span><span class="p">()}</span>
</code></pre></div><p>这里要注意的是，使用<code>XPATH</code>时应该避免使用数组索引（从Chrome的开发者工具里直接复制<code>XPATH</code>就会是这个样子），而应该使用有意义的<code>class</code>或者<code>id</code>来定位。</p>
<h2 id="第三版抽卡机层层剥开验证登录">第三版抽卡机——层层剥开验证登录</h2>
<p>通过学习各种参考资料，我的爬虫水平有了一定程度的提高，也决定用Requests硬刚一下CC98抽卡中心的登录。</p>
<p>在Network标签页中可以看到两次302跳转：</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/oBDPyu.png" alt="两次跳转"></p>
<h3 id="登录cc98登录中心">登录CC98登录中心</h3>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/rvY2kK.png" alt="第一次POST请求的Form Data">
<img src="https://qiniusave.feifeizaici.xyz/uPic/hlvaHe.png" alt=""></p>
<p>首先是<code>用户名</code>、<code>密码</code>、然后<code>ValidTime</code>为空字符串，<code>__RequestVerificationToken</code>和前面一样从html里解析出来。</p>
<h3 id="通过验证界面">通过验证界面</h3>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/mRL9YX.png" alt="第二次POST请求的Form Data"></p>
<p>在Python中模拟，结果收到的响应是这样的：</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/image-20201127192706873.png" alt="错误的Response"></p>
<p>花了很长时间我才发现，Scopes这个参数竟然赋了两次值，第一次复制的结果自然就被第二次覆盖掉了。删掉第二次赋值<code>Scopes: profile</code>以后的<code>response</code>是这样的：</p>
<p><img src="https://qiniusave.feifeizaici.xyz/uPic/ItI19J.png" alt="正确的Response"></p>
<p>返回的这段<code>html</code>代码里包含了最后给<code>signin-cc98</code>发送POST请求时需要的表单信息，把他们都解析出来来就可以了。
<img src="https://qiniusave.feifeizaici.xyz/uPic/A3rJqO.png" alt="第三次POST请求的Form Data"></p>
<h3 id="几个很坑的点">几个很坑的点</h3>
<ul>
<li>url多次跳转，要搞清楚现在在哪个页面</li>
<li>在开发者工具里看不到consent的response</li>
<li>consent表单的字典里有两个相同的key</li>
</ul>
<h2 id="总结">总结</h2>
<p>通过这个小项目，我不经意间学到了很多东西，也发现了目标明确的时候一个人的效率可以有多高。全部代码已经上传到了<a href="https://github.com/FrazierLei/cc98-drawcard">GitHub</a>。</p>

  </article>

  <br/>

  
  
</section>

      </div>
      
        <footer class="footer">
  <section class="container">
    
      <div class="sns-shares sp-sns-shares">
        
        
        
        
        
      </div>
    
    
      <p>Hello, world.</p>
    
     © 2022    ·  Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/naro143/hugo-coder-portfolio">CoderPortfolio</a>. 

  </section>
</footer>
<div class="fixed-bar">
  <section class="container">
    
      <p id="privateTriggerText">霏霏在哪<a id="privateTrigger">Click!</a></p>
    
    
      <div class="sns-shares pc-sns-shares">
        
        
        
        
        
      </div>
    
  </section>
</div>

      
    </main>

    

  <script src="../../js/app.js"></script>
  
  <script>
  (function($) {
    $(function() {
      $('#privateTrigger').on('click', function() {
        $('.private').slideToggle();
        $('#privateTriggerText').text("霏霏在此");
      });
    });
   })(jQuery);
  </script>
  
  </body>
</html>
